{"version":3,"sources":["../../../../../src/streaming/utils/LiveEdgeFinder.js"],"names":[],"mappings":"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","file":"LiveEdgeFinder.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport SynchronizationRulesCollection from '../rules/synchronization/SynchronizationRulesCollection';\nimport Error from '../vo/Error';\nimport EventBus from '../../core/EventBus';\nimport Events from '../../core/events/Events';\nimport RulesController from '../rules/RulesController';\nimport FactoryMaker from '../../core/FactoryMaker';\n\nconst LIVE_EDGE_NOT_FOUND_ERROR_CODE = 1;\n\nfunction LiveEdgeFinder() {\n\n    let context = this.context;\n    let eventBus = EventBus(context).getInstance();\n\n    let instance,\n        timelineConverter,\n        streamProcessor,\n        rulesController,\n        isSearchStarted,\n        searchStartTime,\n        rules,\n        liveEdge,\n        ruleSet;\n\n    function initialize(TimelineConverter, StreamProcessor) {\n        timelineConverter = TimelineConverter;\n        streamProcessor = StreamProcessor;\n        isSearchStarted = false;\n        searchStartTime = NaN;\n        liveEdge = null;\n        rulesController = RulesController(context).getInstance();\n        ruleSet = SynchronizationRulesCollection.BEST_GUESS_RULES;\n        eventBus.on(Events.STREAM_INITIALIZED, onStreamInitialized, this);\n    }\n\n    function abortSearch() {\n        isSearchStarted = false;\n        searchStartTime = NaN;\n    }\n\n    function getLiveEdge() {\n        return liveEdge;\n    }\n\n    function reset() {\n        eventBus.off(Events.STREAM_INITIALIZED, onStreamInitialized, this);\n        abortSearch();\n        liveEdge = null;\n        timelineConverter = null;\n        streamProcessor = null;\n        isSearchStarted = false;\n        searchStartTime = NaN;\n        ruleSet = null;\n        rulesController = null;\n    }\n\n    function onSearchCompleted(req) {\n        var searchTime = (new Date().getTime() - searchStartTime) / 1000;\n        liveEdge = req.value;\n        eventBus.trigger(Events.LIVE_EDGE_SEARCH_COMPLETED, {liveEdge: liveEdge, searchTime: searchTime, error: liveEdge === null ? new Error(LIVE_EDGE_NOT_FOUND_ERROR_CODE, 'live edge has not been found', null) : null});\n    }\n\n    function onStreamInitialized(e) {\n\n        if (!streamProcessor.isDynamic() || isSearchStarted || e.error) {\n            return;\n        }\n\n        ruleSet = timelineConverter.isTimeSyncCompleted() ? SynchronizationRulesCollection.TIME_SYNCHRONIZED_RULES : SynchronizationRulesCollection.BEST_GUESS_RULES;\n\n        rules = SynchronizationRulesCollection(context).getInstance().getRules(ruleSet);\n        isSearchStarted = true;\n        searchStartTime = new Date().getTime();\n\n        rulesController.applyRules(rules, streamProcessor, onSearchCompleted, null, function (currentValue, newValue) {\n            return newValue;\n        });\n    }\n\n    instance = {\n        initialize: initialize,\n        abortSearch: abortSearch,\n        getLiveEdge: getLiveEdge,\n        reset: reset\n    };\n\n    return instance;\n}\nLiveEdgeFinder.__dashjs_factory_name = 'LiveEdgeFinder';\nlet factory = FactoryMaker.getSingletonFactory(LiveEdgeFinder);\nfactory.LIVE_EDGE_NOT_FOUND_ERROR_CODE = LIVE_EDGE_NOT_FOUND_ERROR_CODE;\nexport default factory;"]}